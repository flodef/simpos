<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CORS Debug Tool</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .success {
        background-color: #d4edda;
        border-color: #c3e6cb;
      }
      .error {
        background-color: #f8d7da;
        border-color: #f5c6cb;
      }
      .warning {
        background-color: #fff3cd;
        border-color: #ffeaa7;
      }
      button {
        padding: 10px 15px;
        margin: 5px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      textarea {
        width: 100%;
        height: 200px;
        margin: 10px 0;
      }
      .header-info {
        font-family: monospace;
        background: #f8f9fa;
        padding: 10px;
        border-radius: 3px;
        margin: 5px 0;
      }
    </style>
  </head>
  <body>
    <h1>CORS Debug Tool for SimPOS</h1>

    <div class="section">
      <h3>Backend Server URL</h3>
      <input
        type="text"
        id="serverUrl"
        placeholder="http://your-server:8069"
        style="width: 300px; padding: 5px"
      />
      <button onclick="updateServer()">Update Server</button>
      <p>
        <small
          >Enter your remote Odoo server URL (e.g.,
          http://192.168.1.100:8069)</small
        >
      </p>
    </div>

    <div class="section">
      <h3>Test 1: OPTIONS Preflight Request</h3>
      <button onclick="testOptionsRequest()">Test OPTIONS</button>
      <div id="optionsResult"></div>
    </div>

    <div class="section">
      <h3>Test 2: Actual JSON POST Request</h3>
      <button onclick="testJsonRequest()">Test JSON POST</button>
      <div id="jsonResult"></div>
    </div>

    <div class="section">
      <h3>Test 3: Authentication Flow</h3>
      <button onclick="testFullAuthFlow()">Test Full Auth Flow</button>
      <button onclick="testSigninWithCredentials()">
        Test Sign-in With Credentials
      </button>
      <div id="authResult" class="result"></div>
      <button onclick="copyLogs()" style="margin-bottom: 10px">
        üìã Copy Logs
      </button>
      <button onclick="clearLogs()" style="margin-bottom: 10px">
        üóëÔ∏è Clear Logs
      </button>
    </div>

    <div class="section">
      <h3>Raw Response Headers</h3>
      <textarea
        id="headersLog"
        readonly
        placeholder="Response headers will appear here..."
      ></textarea>
    </div>

    <script>
      let serverUrl = 'http://localhost:8069'; // Default

      function updateServer() {
        const input = document.getElementById('serverUrl');
        if (input.value.trim()) {
          let url = input.value.trim();

          // Extract base URL from full address
          // e.g., http://45.63.115.102:8069/odoo/discuss -> http://45.63.115.102:8069
          try {
            const urlObj = new URL(url);
            serverUrl = `${urlObj.protocol}//${urlObj.host}`;
          } catch (e) {
            // If URL parsing fails, use as-is
            serverUrl = url;
          }

          log(`Server URL updated to: ${serverUrl}`);

          // Update input to show the cleaned URL
          input.value = serverUrl;
        }
      }

      function log(message) {
        const textarea = document.getElementById('headersLog');
        textarea.value += new Date().toISOString() + ': ' + message + '\n';
        textarea.scrollTop = textarea.scrollHeight;
      }

      function displayResult(elementId, success, message, headers = null) {
        const element = document.getElementById(elementId);
        if (!element) {
          console.error(`Element with ID '${elementId}' not found`);
          return;
        }
        element.className = 'section ' + (success ? 'success' : 'error');
        element.innerHTML = `<strong>${success ? '‚úÖ SUCCESS' : '‚ùå ERROR'}:</strong> ${message}`;

        if (headers) {
          let corsHeaders = '';
          for (const [key, value] of headers.entries()) {
            if (key.toLowerCase().startsWith('access-control')) {
              corsHeaders += `<div class="header-info">${key}: ${value}</div>`;
            }
          }
          if (corsHeaders) {
            element.innerHTML += '<h4>CORS Headers Found:</h4>' + corsHeaders;
          } else {
            element.innerHTML +=
              '<div class="warning">‚ö†Ô∏è No CORS headers found in response</div>';
          }
        }
      }

      async function testOptionsRequest() {
        log('Testing OPTIONS preflight request...');
        try {
          const response = await fetch(
            `${serverUrl}/web/dataset/call_kw/res.users/search_read`,
            {
              method: 'OPTIONS',
              headers: {
                Origin: window.location.origin,
                'Access-Control-Request-Method': 'POST',
                'Access-Control-Request-Headers': 'content-type',
              },
            },
          );

          log(`OPTIONS Response: ${response.status} ${response.statusText}`);
          displayResult(
            'optionsResult',
            response.ok,
            `OPTIONS request returned ${response.status}`,
            response.headers,
          );
        } catch (error) {
          log(`OPTIONS Error: ${error.message}`);
          displayResult(
            'optionsResult',
            false,
            `OPTIONS request failed: ${error.message}`,
          );
        }
      }

      async function testJsonRequest() {
        log('Testing JSON POST request...');
        try {
          const response = await fetch(
            `${serverUrl}/web/dataset/call_kw/res.users/search_read`,
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Origin: window.location.origin,
              },
              body: JSON.stringify({
                jsonrpc: '2.0',
                method: 'call',
                params: {
                  model: 'res.users',
                  method: 'search_read',
                  args: [[]],
                  kwargs: { fields: ['name'], limit: 1 },
                },
                id: 1,
              }),
            },
          );

          log(`JSON Response: ${response.status} ${response.statusText}`);
          displayResult(
            'jsonResult',
            response.ok,
            `JSON POST request returned ${response.status}`,
            response.headers,
          );

          const responseText = await response.text();
          log(`Response body preview: ${responseText.substring(0, 200)}...`);
        } catch (error) {
          log(`JSON Error: ${error.message}`);
          displayResult(
            'jsonResult',
            false,
            `JSON POST request failed: ${error.message}`,
          );
        }
      }

      async function testPosMetadata() {
        log('Testing POS Metadata endpoint...');
        try {
          // First test OPTIONS
          const optionsResponse = await fetch(`${serverUrl}/pos_metadata`, {
            method: 'OPTIONS',
            headers: {
              Origin: window.location.origin,
            },
          });

          log(`Metadata OPTIONS: ${optionsResponse.status}`);

          // Then test actual request
          const response = await fetch(`${serverUrl}/pos_metadata`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Origin: window.location.origin,
            },
            body: JSON.stringify({
              params: {
                config_id: 1,
              },
            }),
          });

          log(`Metadata Response: ${response.status} ${response.statusText}`);
          displayResult(
            'signinResult',
            response.status === 200 || response.status === 401,
            `POS Metadata request returned ${response.status}`,
            response.headers,
          );

          if (response.ok) {
            const responseText = await response.text();
            log(`Metadata body preview: ${responseText.substring(0, 200)}...`);
          }
        } catch (error) {
          log(`Metadata Error: ${error.message}`);
          displayResult(
            'signinResult',
            false,
            `POS Metadata request failed: ${error.message}`,
          );
        }
      }

      async function testFullAuthFlow() {
        log('Testing full authentication flow: Sign-in ‚Üí POS Metadata...');
        try {
          // Step 1: Sign in first
          log('Step 1: Authenticating...');
          const signInResponse = await fetch(`${serverUrl}/simpos/v1/sign_in`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Origin: window.location.origin,
            },
            credentials: 'include', // Important: Include cookies for session
            body: JSON.stringify({
              params: {
                login: 'test@tradiz.fr',
                password: 'test',
                db: 'Annette',
              },
            }),
          });

          log(`Sign-in: ${signInResponse.status} ${signInResponse.statusText}`);
          if (signInResponse.ok) {
            const responseText = await signInResponse.text();
            log(
              `Sign-in response preview: ${responseText.substring(0, 200)}...`,
            );
          } else {
            throw new Error(`Sign-in failed: ${signInResponse.status}`);
          }

          // Step 2: Use the authenticated session for metadata
          log('Step 2: Fetching POS metadata with authenticated session...');
          const metadataResponse = await fetch(`${serverUrl}/pos_metadata`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Origin: window.location.origin,
            },
            credentials: 'include', // Use the session from sign-in
            body: JSON.stringify({
              params: {
                config_id: 1,
              },
            }),
          });

          log(
            `Metadata: ${metadataResponse.status} ${metadataResponse.statusText}`,
          );

          displayResult(
            'signinResult',
            metadataResponse.ok,
            `Full auth flow: Sign-in ${signInResponse.status} ‚Üí Metadata ${metadataResponse.status}`,
            metadataResponse.headers,
          );

          if (metadataResponse.ok) {
            const responseText = await metadataResponse.text();
            log(`‚úÖ Success! Metadata: ${responseText.substring(0, 200)}...`);
          }
        } catch (error) {
          log(`‚ùå Full auth flow failed: ${error.message}`);
          displayResult(
            'authResult',
            false,
            `Full auth flow failed: ${error.message}`,
          );
        }
      }

      async function testSigninWithCredentials() {
        log('Testing Sign-in with credentials: include...');
        try {
          // Test OPTIONS first
          const optionsResponse = await fetch(
            `${serverUrl}/simpos/v1/sign_in`,
            {
              method: 'OPTIONS',
              headers: {
                Origin: window.location.origin,
              },
              credentials: 'include',
            },
          );

          log(`Sign-in OPTIONS with credentials: ${optionsResponse.status}`);

          // Then test actual request with credentials (matching real app format)
          const response = await fetch(`${serverUrl}/simpos/v1/sign_in`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Origin: window.location.origin,
            },
            credentials: 'include',
            body: JSON.stringify({
              params: {
                login: 'test@tradiz.fr',
                password: 'test',
                db: 'Annette',
              },
            }),
          });

          log(
            `Sign-in POST with credentials: ${response.status} ${response.statusText}`,
          );
          displayResult(
            'authResult',
            response.status === 200,
            `Sign-in with credentials: ${response.status}`,
            response.headers,
          );

          if (response.ok) {
            const responseText = await response.text();
            log(
              `Sign-in response preview: ${responseText.substring(0, 200)}...`,
            );
          }
        } catch (error) {
          log(`‚ùå Sign-in with credentials failed: ${error.message}`);
          displayResult(
            'authResult',
            false,
            `Sign-in with credentials failed: ${error.message}`,
          );
        }
      }

      function copyLogs() {
        const textarea = document.getElementById('headersLog');
        textarea.select();
        textarea.setSelectionRange(0, 99999); // For mobile devices
        navigator.clipboard
          .writeText(textarea.value)
          .then(() => {
            log('üìã Logs copied to clipboard!');
          })
          .catch(() => {
            // Fallback for older browsers
            document.execCommand('copy');
            log('üìã Logs copied to clipboard!');
          });
      }

      function clearLogs() {
        const textarea = document.getElementById('headersLog');
        textarea.value = '';
        log('üóëÔ∏è Logs cleared');
      }

      // Auto-detect common server URLs
      window.onload = function () {
        log('CORS Debug Tool loaded. Enter your server URL and run tests.');
      };
    </script>
  </body>
</html>
